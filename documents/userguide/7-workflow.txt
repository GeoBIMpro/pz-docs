# Workflow Service

Piazza provides the ability for users to define and send _events_, representing some "thing" that
has happened. These events can be issued either from within Piazza or by an external client. Piazza
also allows for users to define _triggers_, containing both an event-condition and an action: when
the condition is met, the action is performed. Taken together, _event types_, _events_, and
_triggers_ can be used to define _workflows_.

NOTE: By design, events and triggers are fairly primitive, low-level constructs. As Piazza matures,
    richer support for defining workflows may be added.


## An Example

*TODO:* an example scenario to carry through this section

## The EventType

The user (or some service) first defines an `EventType` which is the "schema" for the events that
the user will be generating. The `EventType` object is POSTed to `/eventtypes` and contains
contains a `name` (string) and a map describing the event type's parameters. It also contains a
system-generated ID. For example:

----
{
    "id": "17de4",
    "name": "USDataFound",     # short, id-like string
    "mapping": {
        "ItemId": "string",    # the uuid of the bad data
        "Severity": "integer", # level of offense, 1..5
        "Problem": "string"    # nature of the issue, e.g. US bbox, US phone number, etc
    }
}
----

The available data types are `string`, `boolean`, `integer`, `double`, `date`, `float`, `byte`,
`short`, and `long`. (By no coincidence, these are the basic types that Elasticsearch supports.)


## The Event

The user may generate an `Event` of that `EventType` to indicate some interesting condition has
occurred. The `Event` object is POSTed to `/events` and contains the ID of the `EventType`, the
date the event occurred, and the parameters of the event. It also contains a system-generated ID.
For example:

----
{
    "id": "53dac"
    "eventtype_id": "17de4",
    "date": "2007-04-05T14:30:00Z",
    "data": {
        "ItemId": "eb872",  # in this case, the id of a data item loaded into Pz
        "Severity": 4,
        "Problem": "us-bbox",
        "userName": "my-api-key-38n987",
        "jobId": "43688858-b6d4-4ef9-a98b-163e1980bba8"
    }
}
----

## The Trigger

The user then defines a `Trigger` which defines what action is to be taken when a specific event
occurs. The `Trigger` is POSTed to `/triggers/` and contains two parts, the `Condition` and the
`Job`. The `Condition` defines what type of event is to be watched for and what the specific
parameters of that event should be, expressed using Elasticsearch DSL query syntax against the
parameters in the event type. The `Job` defines what action is to be taken, expressed as using
Gateway/Dispatcher-style syntax. The `Trigger` also contains a system-generated ID. For example:

----
{
    "id": "987d6",
    "title": "my found-a-bad-telephone-number trigger",
    "condition": {
        "eventtype_ids": ["17de4"],   # array of event type ids
        "query": {
            "query" : {    # the Elasticsearch query string
            "bool": {
                    "must": [
                        {
                            "match" : {
                                "Severity" : 4
                            }
                        },
                        {
                            "match" : {
                                "Problem" : "us-bbox"
                            }
                        }
                    ]
                }
            }
        },
        "job": {
            "Task": "{\"userName\": \"$userName\", \"jobType\": {\"type\": \"get\", \"jobId\": \"$jobId\"}}"
        }
    }
}
----

In this example, the job will be executed only when our "US data found" event occurs with the
specific problem being that a US bounding box has been found with a severity of 4.

NOTE: the `Job's Task` is a string that contains JSON. It can be templated and filled in with
    values provided by the event data. To make a value variable, prefix it with a '$'.

NOTE: the "type" field of the "condition" will likely be removed in the future, as the query DSL
    allows us to specify the event type directly within it; this would open up the possibility of
    having a condition based on multiple events.


## The Alert

Whenever the condition of a `Trigger` is met, the system will create an `Alert` object. The user
can GET a list of alerts from `/alerts`. The `Alert` object contains the ids of the `Trigger` that
was hit and the `Event` which caused it. It also contains the now ubiquitous system-generated ID.
For example:

----
{
    "id": "8e6fa",
    "trigger_id": "987d6",
    "event_id": "53dac"
}
----

NOTE: in the future the `event_id` may become an array of event IDs._

NOTE: because we do not yet support an actual `Job` to execute in the `Trigger` definition, the
user can poll the `/alerts` endpoint and perform the required job action manually.

NOTE: the `?trigger=id` and `?after=date` query params will soon be provided to make this polling
process somewhat more palatable._
